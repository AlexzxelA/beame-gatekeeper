<style>
    .red{color:red !important;}
    .revoked{color:#333 !important;text-decoration: line-through}
</style>
<script type="text/x-kendo-template" id="tmpl-creds">
    <h4>Creds tree</h4>
    <div id="creds-tree-container" style="display: inline-block; width:39%;vertical-align: top">
        <div id="creds-tree"></div>
    </div>
    <div id="cred-detail" style="display:inline-block; visibility: hidden; width:59%;border:solid 1px #cacaca; vertical-align: top;padding: 5px;background-color: #fff"></div>
</script>
<script id="treeview-template" type="text/kendo-ui-template">
    # if (item.revoked) { #
    <div class="revoked" data-fqdn="#: item.fqdn#">
    # } else if (item.expired) { #
    <div class="red" data-fqdn="#: item.fqdn#">
    # } else { #
    <div data-fqdn="#: item.fqdn#">
    #}#
        <span title="#: item.isLocal ? 'Local' : 'Remote' #">(#: item.isLocal ? 'L' : 'R' #)</span> #: item.name #
    </div>

</script>
<script>
	function loadCreds() {

		$("#cred-detail").empty().css({visibility:'hidden'});

		function onSelect(e) {


            var dataItem = this.dataItem(e.node);
            if(!dataItem) return;

			$.ajax({
				url: '/cred/detail/' + dataItem.fqdn,
				cache: false,
				type: "Get",
				//data: JSON.stringify(data),
				datatype: "json",
				contentType: "application/json; charset=utf-8"
				, success: function (data) {

					var template = kendo.template($("#tmpl-cred-detail").html());

					var credHtml = template({});

					$("#cred-detail").html(credHtml).promise().done(function(){
						$("#cred-detail").css({visibility:'visible'});
						loadCredDetail(data);
					});
				}
			});
		}

		var treeview = $("#creds-tree").data("kendoTreeView");
		if(treeview){
			$("#creds-tree").remove();

			var treeDiv = $('<div>').attr({id:'creds-tree'});

			$("#creds-tree-container").append(treeDiv);
        }

        var path2Expand = null;

		 $("#creds-tree").kendoTreeView({
			dataSource: new kendo.data.HierarchicalDataSource({
				transport: {
					read: {
						url: '/creds/list',
						dataType: "json"
					}
				},
				schema: {
					model: {
						id: "fqdn",
						hasChildren: "hasChildren"
					}
				},
				requestEnd: function(e) {

                    path2Expand = null;

					if(e.type != "read") return;

                    if(e.response.length != 1) return;

                    var cred = e.response[0];

                    if(!cred.isRoot) return;

					try {
                        path2Expand = cred.fqdn;
					} catch (e) {
					}

				}
			}),
			template: kendo.template($("#treeview-template").html()),
			select: onSelect,
			dataBound: function(e) {

				if(!path2Expand) return;

				try {
					var treeview = e.sender;

					treeview.expandPath([path2Expand]);

					var getitem    = treeview.dataSource.get(path2Expand);
					var selectitem = treeview.findByUid(getitem.uid);
					treeview.select(selectitem);
					treeview.trigger( 'select', {node: selectitem} );

				} catch (e) {
				}

			}
		});

//        return;
//		$("#creds-grid").kendoGrid({
//			toolbar:    ["excel"],
//			excel:      {
//				fileName: "Creds.xlsx",
//				allPages: true
//			},
//			dataSource: {
//				transport: {
//					read:   {
//						url: "/creds/list"
//					}
//				},
//				schema:    {
//					model: {
//						id:     "id",
//						fields: {
//							fqdn:           {type: "string"},
//							name:           {type: "string"},
//							email:          {type: "string"},
//                            parent_fqdn:    {type: "string"},
//							level:          {type: "number"}
////
//						}
//					}
//				},
//				pageSize:  20
////                serverPaging:    true,
////                serverFiltering: true,
////                serverSorting:   true
//			},
//			height:     550,
//			filterable: true,
//			sortable:   true,
//			editable:   {
//				mode:         "inline",
//				confirmation: true
//			},
//			pageable:   {
//				pageSize: 20,
//				refresh:  true
//			},
//			columns:    [
//				{
//					field: "fqdn",
//					title: "Fqdn",
//					width:200
//				},
//				{
//					field: "name",
//					title: "Name",
//					width:100
//				},
//
//				{
//					field: "email",
//					title: "Email",
//                    width:100
//				},
//
//				{
//					field: "parent_fqdn",
//					title: "Parent",
//                    width:200
//				},
//				{
//					field: "level",
//					title: "Level",
//					width:80
//				}
//			]
//		});
	}
</script>