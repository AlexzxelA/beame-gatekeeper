<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.form/3.51/jquery.form.min.js"></script>
<script>
	function rebindInvitations(){
		$("#inv-grid").data('kendoGrid').dataSource.read();
	}

	function onUploadStart(){
		showLoader();
		var token = new Date().getTime();

		setCookie("fileDownloadToken", token, 1);

		// To check the cookie returned back from the server every one second
		var downloadCheck = window.setInterval(function () {
			var cookieValue = getCookie('fileDownloadToken');
			if (!cookieValue){
				hideLoader();
				clearInterval(downloadCheck);
				rebindInvitations();
            }
		}, 100);

	}

</script>

<script type="text/x-kendo-template" id="inv">

    <ul id="inv-panelbar" style="width: 90%;">
        <li>
            <h4>Create Invitation</h4>
            <section id="inv-form-container" style="margin-bottom: 50px">
                <form id="invitation_form" action='/invitation/send' method="post" class="form-main admin-form-main">
                    <div id="inv-info">&nbsp;</div>
                    <input name="name" placeholder="Name" class="form-input"/>
                    <input name="email" type="email" placeholder="Email" class="form-input"/>
                    <input name="user_id" placeholder="External user ID" class="form-input"/>
                    <!--
                    <input name="session_pin" placeholder="4 digits registration code from mobile" class="form-input"/>
                    -->
                    <input type="submit" name="submit" value="Send invitation" class="button">
                </form>
            </section>
        </li>
        <li>
            <h4>Upload Invitations CSV</h4>
            <section id="inv-upload-form-container" style="margin-bottom: 50px">
                <div id="upload-info">&nbsp;</div>
                <form id="upload-form" action="/invitation/upload" method="post" enctype="multipart/form-data"
                      class="form-main admin-form-main">
                    <div>
                        <input type="file" name="csvdata" accept="text/csv" >
                    </div>
                    <div>
                        <input type="submit" value="Upload" class="button" onclick="onUploadStart()" />
                    </div>
                </form>
            </section>
        </li>
    </ul>

    <h4>Invitations Report</h4>
    <div id="inv-grid"></div>
</script>
<script>
	function loadInvitations() {

		$("#inv-grid").kendoGrid({
			toolbar:    ["excel"],
			excel:      {
				fileName: "Invitations.xlsx",
				allPages: true
			},
			dataSource: {
				transport: {
					read:    {
						url: "/invitation/list"
					},
					destroy: {
						url:      "/invitation/destroy",
						method:   "DELETE",
						dataType: "json"
					}
				},
				schema:    {
					model: {
						id:     "id",
						fields: {
							id:        {type: "number"},
							reg_id:    {type: "number"},
							name:      {type: "string"},
							email:     {type: "string"},
							userId:    {type: "string"},
							fqdn:      {type: "string"},
							createdAt: {type: "date"},
							status:    {type: "string"}
						}
					}
				},
				pageSize:  20
//                serverPaging:    true,
//                serverFiltering: true,
//                serverSorting:   true
			},
			height:     550,
			filterable: true,
			sortable:   true,
			editable:   {
				mode:         "inline",
				confirmation: true
			},
			dataBound:  function (e) {
				var grid = e.sender;
				var data = grid.dataSource.data();
				$.each(data, function (i, item) {
					if (item.status == "Completed") {
						$('tr[data-uid="' + item.uid + '"] ').find('.k-grid-delete').hide();//.addClass("disabled");
					}

				});
			},
			remove:     function (e) {
				if (e.model.completed) {
					e.preventDefault();
					alert("Registration is completed, and can't be removed");

				}
			},
			pageable:   {
				pageSize: 20,
				refresh:  true
			},
			columns:    [{
				field:      "id",
				filterable: false
			},
				{
					field: "name",
					title: "Name"
				},
				{
					field: "email",
					title: "Email"
				},
				{
					field: "userId",
					title: "UserId"
				},
				{
					field: "fqdn",
					title: "Fqdn"
				},
				{
					field: "status",
					title: "Status"
				},
				{
					field:  "createdAt",
					title:  "Add On",
					format: "{0:MM/dd/yyyy}"
				},
				{command: "destroy", title: "&nbsp;", width: 100}
			]
		});


		$('#invitation_form').submit(function () {
            showLoader();
			var handleInviResponse = function (response) {
				hideLoader();
				rebindInvitations();
				console.log(response);
				if (response.responseCode == 1) {

					$("#inv-info").removeClass('ad-error').addClass('ad-success');
				}
				else {
					$("#inv-info").removeClass('ad-success').addClass('ad-error');
				}
				$("#inv-info").html(response.responseDesc);
			};

			//	document.getElementById("overlay").style.display = "block";
			$(this).ajaxSubmit({
				error:   handleInviResponse,
				success: handleInviResponse
			});
			//Very important line, it disable the page refresh.
			return false;
		});



	}
</script>