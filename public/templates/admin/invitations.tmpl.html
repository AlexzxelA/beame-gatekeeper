<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.form/3.51/jquery.form.min.js"></script>


<script type="text/x-kendo-template" id="inv">
    <h4>Create Invitation</h4>
    <section id="inv-form-container" style="margin-bottom: 50px">
        <form id="invitation_form" action='/invitation/send' method="post" class="form-main">
            <div id="inv-info">&nbsp;</div>
            <input name="name" placeholder="Name" class="form-input"/>
            <input name="email" type="email" placeholder="Email" class="form-input"/>
            <input name="user_id" placeholder="External user ID" class="form-input"/>
            <!--
            <input name="session_pin" placeholder="4 digits registration code from mobile" class="form-input"/>
            -->
            <input type="submit" name="submit" value="Send invitation" class="button">
        </form>
    </section>


    <h4>Upload Invitations CSV</h4>
    <section id="inv-upload-form-container" style="margin-bottom: 50px">
            <form id="upload-form" action="/upload/data" method="post" enctype="multipart/form-data"  class="form-main">
                <fieldset>
                    <legend>Upload Data</legend>
                    <div>
                        <!-- The name here is important, and will be used later to reference the data -->
                        <input type="file" name="csvdata" accept="text/csv" class="button">
                    </div>
                    <div>
                        <input type="submit" value="Submit" class="button"/>
                    </div>
                </fieldset>
            </form>
    </section>



    <h4>Invitations Report</h4>
    <div id="inv-grid"></div>
</script>
<script>
	function loadInvitations() {

		$("#inv-grid").kendoGrid({
			toolbar:    ["excel"],
			excel:      {
				fileName: "Registrations.xlsx",
				allPages: true
			},
			dataSource: {
				transport: {
					read:    {
						url: "/registration/list"
					},
					destroy: {
						url:      "/registration/destroy",
						method:   "POST",
						dataType: "json"
					}
				},
				schema:    {
					model: {
						id:     "id",
						fields: {
							id:        {type: "number"},
							name:      {type: "string"},
							email:     {type: "string"},
							fqdn:      {type: "string"},
							createdAt: {type: "date"},
							source:    {type: "string"},
							completed: {type: "boolean"}
						}
					}
				},
				pageSize:  20
//                serverPaging:    true,
//                serverFiltering: true,
//                serverSorting:   true
			},
			height:     550,
			filterable: true,
			sortable:   true,
			editable:   {
				mode:         "inline",
				confirmation: true
			},
			dataBound: function(e) {
				var grid = e.sender;
				var data = grid.dataSource.data();
				$.each(data, function (i, item) {
					if (item.completed ) {
						$('tr[data-uid="' + item.uid + '"] ').find('.k-grid-delete').hide();//.addClass("disabled");
					}

				});
			},
			remove: function(e) {
				if (e.model.completed) {
					e.preventDefault();
					alert("Registration is completed, and can't be removed");

				}
			},
			pageable:   {
				pageSize: 20,
				refresh:  true
			},
			columns:    [{
				field:      "id",
				filterable: false
			},
				{
					field: "name",
					title: "Name"
				},
				{
					field: "email",
					title: "Email"
				},

				{
					field: "fqdn",
					title: "Fqdn"
				},
				{
					field: "source",
					title: "Source"
				},
				{
					field: "completed",
					title: "Completed"
				},
				{
					field:  "createdAt",
					title:  "Add On",
					format: "{0:MM/dd/yyyy}"
				},
				{command: "destroy", title: "&nbsp;", width: 100}
			]
		});

		initInvForm();
	}

	function initInvForm(){
		$('#invitation_form').submit(function () {
			console.log('huy');
			//	document.getElementById("overlay").style.display = "block";
			$(this).ajaxSubmit({
				error: function (response) {
					console.log('success response',response);
					$("#inv-info").html(response.responseDesc);
					$("#inv-info").removeClass('ad-success').addClass('ad-error');
				},
				success: function (response) {
					document.getElementById("inv-info").innerHTML = response.responseDesc;
					$("#inv-grid").data('kendoGrid').dataSource.read();
					$("#inv-info").removeClass('ad-error').addClass('ad-success');
				}
			});
			//Very important line, it disable the page refresh.
			return false;
		});
    }
</script>