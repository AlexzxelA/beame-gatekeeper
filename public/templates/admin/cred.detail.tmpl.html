<!--suppress ALL -->
<style>
    .metrotable > thead > tr > th {
        padding: 2em 1em 0 0;
        text-transform: lowercase;
        text-align: left;
        font-size: 2em;
        font-weight: lighter;
        color: #bbb;
        border-bottom: 1px solid #ccc;
    }

    .metrotable > tbody > tr > td {
        padding: .5em 1em .5em 0;
        text-transform: lowercase;
        text-align: left;
        font-size: 1.2em;
        font-weight: lighter;
        color: #787878;
        border-bottom: 1px solid #e1e1e1;
    }

    .metrotable > tbody > tr > td {
        font-size: 12px;
    }

    .metrotable > thead > tr > th {
        font-size: 14px;
        padding-top: 0;
    }
</style>

<script id="tmpl-cred-detail" type="text/x-kendo-template">
    <h4>Cred Details</h4>
    <section id="cred-form-container" style="margin-bottom: 50px">
        <form id="cred-detail-form" class="admin-form-main">
            <div id="cred-info" class="invisible-msg">&nbsp;</div>
            <label class="lbl-info">Fqdn: <span data-bind="text: data.fqdn"></span></label>
            <label class="lbl-info">Valid till: <span data-bind="text: data.validTill"></span></label>
            <label class="lbl-info">Revoked: <input type="checkbox" disabled data-bind="checked: data.revoked"/></label>
            <label class="lbl-info" data-bind="visible:data.parent_fqdn,attr:{title:data.parent_fqdn}">Parent: <span
                data-bind="text:parentName()"></span></label>
            <label class="lbl-info">Name: <span data-bind="text: data.name"></span></label>
            <label class="lbl-info">Email: <span data-bind="text: data.email"></span></label>
            <label class="lbl-info" data-bind="visible:data.pwd">Pfx Pwd: <span
                data-bind="text: data.pwd"></span></label>
        </form>

        <div class="btn-row">
            <h5>Cert Actions</h5>
            <input type="button" name="btn-renew" data-bind="disabled:renewButtonDisabled,click:renewCert" value="Renew"
                   class="k-button">
            <input type="button" name="btn-revoke" data-bind="disabled:revokeDisabled,click:revokeCert" value="Revoke"
                   class="k-button">
            <input type="button" disabled data-bind="visible:data.isLocal" name="btn-purge" value="Purge"
                   class="k-button">
        </div>

        <div class="btn-row">
            <h5>Cred Actions</h5>
            <input type="button" data-bind="disabled:commonButtonDisabled,click:openCredWnd" value="Create Child"
                   class="k-button">
            <input type="button" data-bind="disabled:commonButtonDisabled,click:openRegtokenWnd"
                   value="Create Registration Token" class="k-button">
        </div>


        <div class="btn-row">
            <h5>Share Cred</h5>
            <form id="frm-send-pfx-email" action="/send/pfx" data-bind="visible:emailFormVisible" method="post"
                  class="admin-form-main">
                <div id="send_pfx_form_info" class="invisible-msg">&nbsp;</div>
                <input name="email" required type="email" placeholder="Email"
                       data-bind="disabled:commonButtonDisabled,value: data.email" class="form-input"/>
                <input name="fqdn" required type="hidden" data-bind="value: data.fqdn"/>
                <input type="button" id="btn-send-pfx-email" name="btn-email" data-bind="disabled:commonButtonDisabled"
                       value="Send Pfx by Email" class="k-button">
            </form>
            <div>
                <input type="button" name="btn-qr" data-bind="disabled:commonButtonDisabled,click: showCredQr"
                       value="Show QR" class="k-button">
                <a data-bind="attr: { href: data.pfx_path },visible:data.pfx_path" target="_blank"
                   class="k-button inline">Download Pfx</a>
            </div>
        </div>

        <div class="btn-row">
            <h5>VPN Actions</h5>
            <input type="button" name="btn-set-vpn" data-bind="disabled:commonButtonDisabled,click:opneVPN"
                   value="Set VPN" class="k-button">
            <form id="ios-profile-form" method="get" style="margin: 15px 0" target="_blank"
                  data-bind="visible:iosVpnProfileVisible">
                <div id="ios-profile-info">&nbsp;</div>
                <input type="submit" class="k-button" id="btn-ios-profile" value="Download IOS VPN  profile"/>
                <input type="button" name="btn-qr" data-bind="disabled:commonButtonDisabled,click: showIosProfileQr"
                       value="Show Profile QR" class="k-button">
            </form>

        </div>

        <div data-bind="visible:data.actions.length">
            <h5>History</h5>
            <table class="metrotable">
                <thead>
                <tr>
                    <th>Action</th>
                    <th>Email</th>
                    <th>Name</th>
                    <th>Date</th>
                </tr>
                </thead>
                <tbody data-template="history-row-template" data-bind="source: data.actions"></tbody>
            </table>
        </div>

    </section>


</script>

<script id="vpn-detail" type="text/x-kendo-template">
    <label class="lbl-info">Fqdn: <span data-bind="text:data.fqdn"></span></label>
    <form id="frm-vpn-detail" method="post" action="/cred/set-vpn/create" class="admin-form-main" style="width:400px">
        <div id="frm-vpn-detail_info" class="invisible-msg">&nbsp;</div>
        <input type="hidden" name="vpn_id" data-bind="value:vpnId">
        <input name="name" required type="text" placeholder="VPN ID" data-bind="value:name" class="form-input"/>
        <input name="fqdn" required type="hidden" data-bind="value: data.fqdn"/>
        <input type="submit" name="btn-set-vpn" value="Set VPN" class="k-button">
        <input type="button" name="btn-set-vpn" data-bind="enabled: vpnId,click:deleteVpn" value="Delete VPN"
               class="k-button">
    </form>

    <form id="frm-vpn-delete" method="post" action="/cred/set-vpn/delete">
        <input name="vpn_id" type="hidden" data-bind="value:vpnId">
        <input name="name" type="hidden" data-bind="value:name"/>
        <input name="fqdn" type="hidden" data-bind="value:data.fqdn"/>
    </form>


    <div id="wnd-overlay" class="overlay" style="max-height: 100% !important">
        <div>
            <h3>Processing Request</h3>
            <svg class="spinner" viewBox="0 0 50 50">
                <circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle>
            </svg>
        </div>
    </div>
</script>

<script id="history-row-template" type="text/x-kendo-template">
    <tr>
        <td data-bind="text: action"></td>
        <td data-bind="text: email"></td>
        <td data-bind="text: name"></td>
        <td data-bind="text: dateStr"></td>
    </tr>
</script>

<script id="tmpl-create-child-cred" type="text/x-kendo-template">
    <form id="frm-create-child-cred" action='/cred/create' method="post" class="form-main admin-form-main">
        <label class="lbl-info">Create child credential for</label>
        <label class="lbl-info">Fqdn: #: fqdn#</label>
        # if(name) {#
        <label class="lbl-info">Name: #: name#</label>
        # } #
        <input id="fqdn" type="hidden" name="fqdn" value="#: fqdn#"/>
        <input name="name" placeholder="Name" class="form-input"/>
        <input name="email" type="email" placeholder="Email" class="form-input"/>
        <input name="password" placeholder="Pfx Password (min 8 chars)" pattern=".{8,16}" class="form-input"/>
        <div id="create-child-cred-info" class="invisible-msg">&nbsp;</div>
        <input type="button" value="Create Certificate" class="k-primary" id="btn-create-child-cred">
    </form>
    <div id="wnd-overlay" class="overlay" style="max-height: 100% !important">
        <div>
            <h3>Processing Request</h3>
            <svg class="spinner" viewBox="0 0 50 50">
                <circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle>
            </svg>
        </div>
    </div>
</script>

<script id="tmpl-create-regtoken" type="text/x-kendo-template">
    <form id="frm-create-regtoken" action='/regtoken/create' method="post" class="form-main admin-form-main">

        <label class="lbl-info">Create registration token signed by</label>
        <label class="lbl-info">Fqdn: #: fqdn#</label>
        # if(name) {#
        <label class="lbl-info">Name: #: name#</label>
        # } #
        <input id="fqdn" type="hidden" name="fqdn" value="#: fqdn#"/>
        <input name="name" placeholder="Name" class="form-input"/>
        <input name="email" type="email" placeholder="Email" class="form-input"/>
        <input name="user_id" placeholder="External user ID" class="form-input"/>
        <input name="ttl" placeholder="Token TTL in seconds" class="form-input"/>

        <div id="token-info" class="invisible-msg">&nbsp;</div>
        <input type="button" value="Create Registration Token" class="k-primary" id="btn-create-regtoken">
    </form>

    <div id="reg-token-container" style="display:none;" class="form-main admin-form-main">
        <input type="button" id="btn-regtoken-back" value="back">
        <input id="copy-btn" type="submit" name="submit" value="Copy to clipboard" class="k-button" data-clipboard-action="copy" />
        <textarea id="reg_token" name="reg_token" style="width: 80%;margin: 15px 0 0;" rows="10"></textarea>
    </div>

    <div id="wnd-overlay" class="overlay" style="max-height: 100% !important">
        <div>
            <h3>Processing Request</h3>
            <svg class="spinner" viewBox="0 0 50 50">
                <circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle>
            </svg>
        </div>
    </div>
</script>

<div id="qr-window" class="wnd-default">
    <div id="download-qr" style="margin: auto;width: 300px"></div>
</div>

<div id="vpn-window" class="wnd-default"></div>

<div id="create-child-cred-window" class="wnd-default"></div>

<div id="create-regtoken-window" class="wnd-default"></div>

<script>
	var credDetailViewModel, vpnDetailViewModel,
	    qrWnd       = $("#qr-window"),
	    vpnWnd      = $('#vpn-window'),
	    credWnd     = $('#create-child-cred-window'),
	    regtokenWnd = $('#create-regtoken-window');

	function closeWnd() {
		$(".k-window .k-window-content").each(function (index, element) {
			$(element).data("kendoWindow").close();
		});
	}

	function bindEmailEvent() {

		$('#btn-send-pfx-email').off('click').on('click', function (e) {

			e.preventDefault();

			showLoader();

			var form     = $('#frm-send-pfx-email'),
			    url      = form.attr('action'),
			    method   = form.attr('method'),
			    formData = {
				    fqdn:  form.find('input[name="fqdn"]').val(),
				    email: form.find('input[name="email"]').val()
			    };
			console.log('form data', formData);
			$.ajax({
				url:         url,
				cache:       false,
				data:        JSON.stringify(formData),
				type:        method,
				datatype:    "json",
				contentType: "application/json; charset=utf-8"
				, success:   function (response) {

					hideLoader();
					if (response.responseCode == 1) {
						response.responseDesc = 'Email sent to ' + ( $('#frm-send-pfx-email input[name="email"]').val());
						$("#send_pfx_form_info").removeClass('ad-error').addClass('ad-success');
						if (response.data && credDetailViewModel) {
							credDetailViewModel.set("data", response.data);
						}

					}
					else {
						$("#send_pfx_form_info").removeClass('ad-success').addClass('ad-error');

					}
					$("#send_pfx_form_info").html(response.responseDesc);
				}
			});
		});
	}

	function setVpn() {
		showLoader('wnd-overlay');

		var handleSendCredResponse = function (response) {
			hideLoader('wnd-overlay');

			if (response.responseCode == 1) {
				response.responseDesc = 'Vpn settings saved';
				$("#frm-vpn-detail_info").removeClass('ad-error').addClass('ad-success');
				if (response.data) {
					if (credDetailViewModel) {
						credDetailViewModel.set("data", response.data);
					}


					vpnDetailViewModel.set("data", response.data);
					vpnDetailViewModel.init();
				}
			}
			else {
				$("#frm-vpn-detail_info").removeClass('ad-success').addClass('ad-error');

			}
			$("#frm-vpn-detail_info").html(response.responseDesc);
		};


		$(this).ajaxSubmit({
			error:   handleSendCredResponse,
			success: handleSendCredResponse
		});

		return false;
	}

	function initVpnWindow() {
		var template = kendo.template($("#vpn-detail").html());
		vpnWnd.empty();
		vpnWnd.kendoWindow({
			width:   "450px",
			height:  "400px",
			title:   "Set VPN",
			visible: false,
			modal:   true,
			content: {
				template: template
			},
			actions: [
				"Close"
			],
			open:    function () {
				vpnDetailViewModel.init();
				kendo.bind($("#vpn-window"), vpnDetailViewModel);
				$('#frm-vpn-detail').submit(setVpn);
				$('#frm-vpn-delete').submit(setVpn);
			}
		});
	}

	function initCredWindow(fqdn, name) {
		var template     = kendo.template($("#tmpl-create-child-cred").html());
		var fqdnTemplate = template({fqdn: fqdn, name: name});
		credWnd.empty();
		credWnd.kendoWindow({
			width:   "440px",
			height:  "450px",
			title:   "Create Child Credential",
			visible: false,
			modal:   true,
			content: {
				template: fqdnTemplate
			},
			actions: [
				"Close"
			],
			open:    function () {
				$('#btn-create-child-cred').off('click').on('click', function (e) {
					showLoader('wnd-overlay');
					e.preventDefault();
					var form     = $('#frm-create-child-cred'),
					    url      = form.attr('action'),
					    method   = form.attr('method'),
					    formData = {
						    fqdn:     form.find('input[name="fqdn"]').val(),
						    name:     form.find('input[name="name"]').val(),
						    email:    form.find('input[name="email"]').val(),
						    password: form.find('input[name="password"]').val()
					    };
					console.log('form data', formData);
					$.ajax({
						url:         url,
						cache:       false,
						data:        JSON.stringify(formData),
						type:        method,
						datatype:    "json",
						contentType: "application/json; charset=utf-8"
						, success:   function (response) {

							hideLoader('wnd-overlay');
							var info = $('#create-child-cred-info');
							console.log(response);
							if (response.responseCode == 1) {

								info.removeClass('ad-error').addClass('ad-success');
								window.getNotifManagerInstance().notify('credsChanged', {fqdn: fqdn})
							}
							else {
								info.removeClass('ad-success').addClass('ad-error');

							}
							info.html(response.responseDesc);
						}
					});
				});
			}
		});
	}


	function initRegtokenWindow(fqdn, name) {
		var template     = kendo.template($("#tmpl-create-regtoken").html());
		var fqdnTemplate = template({fqdn: fqdn, name: name});
		regtokenWnd.empty();
		regtokenWnd.kendoWindow({
			width:   "440px",
			height:  "450px",
			title:   "Create Child Credential",
			visible: false,
			modal:   true,
			content: {
				template: fqdnTemplate
			},
			actions: [
				"Close"
			],
			open:    function () {
				new Clipboard('#copy-btn');
				$('#copy-btn').attr("data-clipboard-target","#reg_token");

				$('#btn-regtoken-back').off('click').on('click',function(){
					$('#frm-create-regtoken').show();
					$('#reg-token-container').hide();
                });

				$('#btn-create-regtoken').off('click').on('click', function (e) {
					showLoader('wnd-overlay');
					e.preventDefault();


					$('#reg_token').html(null);
					$('#reg-token-container').hide();

					var form     = $('#frm-create-regtoken'),
					    url      = form.attr('action'),
					    method   = form.attr('method'),
					    formData = {
						    fqdn:    form.find('input[name="fqdn"]').val(),
						    name:    form.find('input[name="name"]').val(),
						    email:   form.find('input[name="email"]').val(),
						    user_id: form.find('input[name="user_id"]').val(),
						    ttl:     form.find('input[name="ttl"]').val()
					    };

					$.ajax({
						url:         url,
						cache:       false,
						data:        JSON.stringify(formData),
						type:        method,
						datatype:    "json",
						contentType: "application/json; charset=utf-8"
						, success:   function (response) {
							hideLoader('wnd-overlay');
							console.log(response);
							if (response.responseCode == 1) {

								$("#token-info").removeClass('ad-error').addClass('ad-success');

								$('#reg_token').html(response.token);
								$('#frm-create-regtoken').hide();
								$('#reg-token-container').show();
							}
							else {
								$("#token-info").removeClass('ad-success').addClass('ad-error');
							}
							$("#token-info").html(response.responseDesc);
						}
					});

				});
			}
		});
	}

	function initQrWindow(url) {
		if (url) {
			qrWnd.kendoWindow({
				width:   "320px",
				height:  "320px",
				title:   "Scan QR",
				visible: false,
				modal:   true,
				actions: [
					"Close"
				]
			});

			$('#download-qr').empty().kendoQRCode({
				value:           url,
				errorCorrection: "L",
				color:           "#000",
				background:      "transparent",
				padding:         0,
				size:            300
			});
		}
	}

	function loadCredDetail(data) {

		window.getNotifManagerInstance().subscribe('MenuClicked', function () {
			closeWnd();
		});

		credDetailViewModel = kendo.observable({
			init:                 function () {

				closeWnd();

				//initVpnWindow();

				this.set('revokeDisabled', this.data.hasChildren || this.data.revoked);
				this.set('commonButtonDisabled', this.data.revoked);
				this.set('renewButtonDisabled', this.data.revoked || !this.data.isLocal);
				this.set('emailFormVisible', !this.data.revoked && this.data.pwd);
				this.set('iosVpnProfileVisible', this.data.vpn_server_fqdn);

				bindEmailEvent();

				$('#ios-profile-form').attr('action', this.iosProfileLink());
			},
			revokeDisabled:       true,
			commonButtonDisabled: false,
			renewButtonDisabled:  false,
			emailFormVisible:     true,
			iosVpnProfileVisible: false,
			data:                 data,

			parentName:       function () {
				return this.data.parent_name ? `${this.data.parent_name} (${this.data.parent_fqdn})` : this.data.parent_fqdn
			},
			sendPfxUrl:       function () {
				return '/send/pfx/' + this.data.fqdn
			},
			showCredQr:       function () {
				if (!this.data.download_cred_url) {
					alert('Cred download url not defined');
					return;
				}
				this.operQrWnd(this.data.download_cred_url);
			},
			showIosProfileQr: function () {
				if (!this.data.download_ios_profile_url) {
					alert('Ios Profile download url not defined');
					return;
				}
				this.operQrWnd(this.data.download_ios_profile_url);
			},
			operQrWnd:        function (url) {
				initQrWindow(url);
				closeWnd();
				qrWnd.data("kendoWindow").center().open();
			},
			iosProfileLink:   function () {
				return "/cred/ios-profile/" + this.data.fqdn;
			},
			opneVPN:          function () {
				initVpnWindow();
				vpnWnd.data("kendoWindow").center().open();
			},
			openCredWnd:      function () {
				initCredWindow(this.data.fqdn, this.data.name);
				credWnd.data("kendoWindow").center().open();
			},
			openRegtokenWnd:  function () {
				initRegtokenWindow(this.data.fqdn, this.data.name);
				regtokenWnd.data("kendoWindow").center().open();
			},
			renewCert:        function () {

				showLoader();
				$.ajax({
					url:         '/cred/renew/' + this.data.fqdn,
					cache:       false,
					type:        "Post",
					datatype:    "json",
					contentType: "application/json; charset=utf-8"
					, success:   function (response) {

						hideLoader();

						if (response.responseCode == 1) {
							$("#cred-info").removeClass('ad-error').addClass('ad-success');
							if (response.data && credDetailViewModel) {
								credDetailViewModel.set("data", response.data);
							}
						}
						else {
							$("#cred-info").removeClass('ad-success').addClass('ad-error');

						}
						$("#cred-info").html(response.responseDesc);
					}
				});
			},
			revokeCert:       function () {
				var $this = this;
				showLoader();
				$.ajax({
					url:         '/cred/revoke/' + this.data.fqdn,
					cache:       false,
					type:        "Post",
					datatype:    "json",
					contentType: "application/json; charset=utf-8"
					, success:   function (response) {

						hideLoader();

						if (response.responseCode == 1) {
							$("#cred-info").removeClass('ad-error').addClass('ad-success');
							if (response.data && credDetailViewModel) {
								credDetailViewModel.set("data", response.data);
								credDetailViewModel.init();
							}
							console.log('revoke');
							$('#creds-tree').find('div[data-fqdn="' + $this.data.fqdn + '"]').addClass('revoked');
						}
						else {
							$("#cred-info").removeClass('ad-success').addClass('ad-error');

						}
						$("#cred-info").html(response.responseDesc);
					}
				});
			}

		});

		credDetailViewModel.init();
		kendo.bind($("#cred-form-container"), credDetailViewModel);

		vpnDetailViewModel = kendo.observable({
			init:      function () {
				var vpns = this.data.vpn;
				if (!vpns || !vpns.length) {
					this.set('vpnId', null);
					this.set('name', null);
					return;
				}

				var vpn = vpns[0];

				this.set('vpnId', vpn.id);
				this.set('name', vpn.name);
			},
			vpnId:     null,
			name:      null,
			data:      data,
			deleteVpn: function () {
				this.set('name', null);
				$('#frm-vpn-delete').submit();
			}
		});

	}
</script>