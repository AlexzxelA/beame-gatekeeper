<style>
    .metrotable > thead > tr > th {
        padding: 2em 1em 0 0;
        text-transform: lowercase;
        text-align: left;
        font-size: 2em;
        font-weight: lighter;
        color: #bbb;
        border-bottom: 1px solid #ccc;
    }

    .metrotable > tbody > tr > td {
        padding: .5em 1em .5em 0;
        text-transform: lowercase;
        text-align: left;
        font-size: 1.2em;
        font-weight: lighter;
        color: #787878;
        border-bottom: 1px solid #e1e1e1;
    }

    .metrotable > tbody > tr > td {
        font-size: 12px;
    }

    .metrotable > thead > tr > th {
        font-size: 14px;
        padding-top: 0;
    }
</style>
<script src="lib/kendo-2016.3.1118.qr.min.js"></script>
<script type="text/x-kendo-template" id="tmpl-cred-detail">


    <h4>Cred Details</h4>
    <section id="cred-form-container" style="margin-bottom: 50px">
        <form id="cred-detail-form" class="form-main admin-form-main">
            <div id="pfx-info">&nbsp;</div>
            <label class="lbl-info">Fqdn: <span data-bind="text: data.fqdn"></span></label>
            <label class="lbl-info">Valid till: <span data-bind="text: data.validTill"></span></label>
            <label class="lbl-info" data-bind="visible:data.parent_fqdn,attr:{title:data.parent_fqdn}">Parent: <span data-bind="text:parentName()"></span></label>
            <label class="lbl-info">Name: <span data-bind="text: data.name"></span></label>
            <label class="lbl-info">Email: <span data-bind="text: data.email"></span></label>
            <label class="lbl-info" data-bind="visible:data.pwd">Pfx Pwd: <span data-bind="text: data.pwd"></span></label>
            <a data-bind="attr: { href: data.pfx_path },visible:data.pfx_path" target="_blank">Download Pfx</a>
        </form>
        <p class="btn-row">
            <input type="button" name="btn-set-vpn" data-bind="click:opneVPN" value="Set VPN" class="button">
            <input type="button" name="btn-renew" value="Renew" class="button">
            <input type="button" disabled name="btn-revoke" value="Revoke" class="button">
            <input type="button" disabled data-bind="visible:data.isLocal" name="btn-purge" value="Purge" class="button">
        </p>


        <form id="send_pfx_form" action="/send/pfx" data-bind="visible:data.pwd" method="post" class="admin-form-main" style="margin: 15px 0">
            <h5>Send Pfx by email</h5>
            <div id="send_pfx_form_info">&nbsp;</div>
            <input name="email" required type="email" placeholder="Email" data-bind="value: data.email" class="form-input"/>
            <input name="fqdn" required type="hidden" data-bind="value: data.fqdn"/>
            <input type="submit" name="btn-email" value="Send Pfx by Email" class="button">
            <input type="button" name="btn-qr" data-bind="click: showQr" value="Show QR" class="button">
        </form>

        <div data-bind="visible:data.actions.length">
            <h5>History</h5>
            <table class="metrotable">
                <thead>
                <tr>
                    <th>Action</th>
                    <th>Email</th>
                    <th>Name</th>
                    <th>Date</th>
                </tr>
                </thead>
                <tbody data-template="history-row-template" data-bind="source: data.actions"></tbody>
            </table>
        </div>

    </section>


</script>

<div id="qr-window" style="display: none;text-align: center">
    <div id="download-qr" style="margin: auto;width: 300px"></div>
</div>

<div id="vpn-window" style="display: none;text-align: center">
    <!--<div id="vpn-detail-container"></div>-->
</div>

<script type="text/x-kendo-template" id="vpn-detail">
    <label class="lbl-info">Fqdn: <span data-bind="text:data.fqdn"></span></label>
    <form id="vpn_detail_form"  method="post" action="/cred/set-vpn/create" class="admin-form-main" style="width:400px">
        <div id="vpn_detail_form_info">&nbsp;</div>
        <input type="hidden" name="vpn_id" data-bind="value:vpnId">
        <input name="name" required type="text" placeholder="VPV ID" data-bind="value:name" class="form-input"/>
        <input name="fqdn" required type="hidden" data-bind="value: data.fqdn"/>
        <input type="submit" name="btn-set-vpn" value="Set VPN" class="button">
        <input type="button" name="btn-set-vpn" data-bind="enabled: vpnId,click:deleteVpn" value="Delete VPN" class="button">
    </form>

    <form id="vpn_delete_form"  method="post" action="/cred/set-vpn/delete">
        <input name="vpn_id" type="hidden" data-bind="value:vpnId">
        <input name="name"   type="hidden" data-bind="value:name"/>
        <input name="fqdn"   type="hidden" data-bind="value:data.fqdn"/>
    </form>


    <div id="wnd-overlay" class="overlay" style="max-height: 100% !important">
        <div>
            <h3>Processing Request</h3>
            <svg class="spinner" viewBox="0 0 50 50">
                <circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle>
            </svg>
        </div>
    </div>
</script>

<script id="history-row-template" type="text/x-kendo-template">
    <tr>
        <td data-bind="text: action"></td>
        <td data-bind="text: email"></td>
        <td data-bind="text: name"></td>
        <td data-bind="text: dateStr"></td>
    </tr>
</script>

<script>
	var credDetailViewModel,vpnDetailViewModel, qrWnd = $("#qr-window"),vpnWnd = $('#vpn-window');

	function closeWnd(id) {

		var wnd = $(id);

		if (wnd.data("kendoWindow")) {
			wnd.data("kendoWindow").close();
		}
	}

	function sendEmail(){
		showLoader();

		var handleSendCredResponse = function (response) {
			hideLoader();

			if (response.responseCode == 1) {
				response.responseDesc = 'Email sent to ' + ( $('#send_pfx_form input[name="email"]').val());
				$("#send_pfx_form_info").removeClass('ad-error').addClass('ad-success');
				if (response.data && credDetailViewModel) {
					credDetailViewModel.set("data", response.data);
				}

			}
			else {
				$("#send_pfx_form_info").removeClass('ad-success').addClass('ad-error');

			}
			$("#send_pfx_form_info").html(response.responseDesc);
		};


		$(this).ajaxSubmit({
			error:   handleSendCredResponse,
			success: handleSendCredResponse
		});

		return false;
    }

    function setVpn(){
		showLoader('wnd-overlay');

		var handleSendCredResponse = function (response) {
			hideLoader('wnd-overlay');

			if (response.responseCode == 1) {
				response.responseDesc = 'Vpn settings saved';
				$("#vpn_detail_form_info").removeClass('ad-error').addClass('ad-success');
				if (response.data) {
					if(credDetailViewModel) {
						credDetailViewModel.set("data", response.data);
					}


					vpnDetailViewModel.set("data", response.data);
					vpnDetailViewModel.init();
				}
			}
			else {
				$("#vpn_detail_form_info").removeClass('ad-success').addClass('ad-error');

			}
			$("#vpn_detail_form_info").html(response.responseDesc);
		};


		$(this).ajaxSubmit({
			error:   handleSendCredResponse,
			success: handleSendCredResponse
		});

		return false;
    }

	function loadCredDetail(data) {

		console.log('huy',data);

		window.getNotifManagerInstance().subscribe('MenuClicked',function(){
			closeWnd('#qr-window');
			closeWnd('#vpn-window');
        });

		credDetailViewModel = kendo.observable({
			init: function () {

				closeWnd('#qr-window');
				closeWnd('#vpn-window');

				if (this.data.download_url) {
					qrWnd.kendoWindow({
						width:   "320px",
						height:  "320px",
						title:   "Scan QR",
						visible: false,
						modal:true,
						actions: [
							"Close"
						]
					});

					$('#download-qr').empty().kendoQRCode({
						value:           this.data.download_url,
						errorCorrection: "L",
						color:           "#000",
						background:      "transparent",
						padding:         0,
						size:            300
					});
				}

				var template = kendo.template($("#vpn-detail").html());

				vpnWnd.kendoWindow({
					width:   "450px",
					height:  "400px",
					title:   "Set VPN",
					visible: false,
					modal:true,
					content:{
						template:template
                    },
					actions: [
						"Close"
					],
					open: function() {
						vpnDetailViewModel.init();
						kendo.bind($("#vpn-window"), vpnDetailViewModel);
						$('#vpn_detail_form').submit(setVpn);
						$('#vpn_delete_form').submit(setVpn);
					}
				});

				$('#send_pfx_form').submit(sendEmail);
			},
			data: data,

			parentName: function () {
                return this.data.parent_name  ? `${this.data.parent_name} (${this.data.parent_fqdn})` : this.data.parent_fqdn
			},
			sendPfxUrl: function () {
				return '/send/pfx/' + this.data.fqdn
			},
			showQr:     function () {
				closeWnd('#vpn-window');
				qrWnd.data("kendoWindow").center().open();
			},
			opneVPN:function(){
				closeWnd('#qr-window');
				vpnWnd.data("kendoWindow").center().open();
            }

		});

		credDetailViewModel.init();
		kendo.bind($("#cred-form-container"), credDetailViewModel);

		vpnDetailViewModel = kendo.observable({
            init:function(){
	            var vpns = this.data.vpn;
	            if(!vpns || !vpns.length) {
		            this.set('vpnId',null);
		            this.set('name',null);
	            	return;
                }

	            var vpn = vpns[0];

                this.set('vpnId',vpn.id);
                this.set('name',vpn.name);
            },
            vpnId :null,
            name:null,
            data:data,
			deleteVpn:function(){
				this.set('name',null);
				$('#vpn_delete_form').submit();
            }
        });

	}
</script>